import { Steps,Callout,Cards } from 'nextra/components'

# 上报第一个覆盖率数据

## 从模板快速启动

### 部署到 Vercel

您可以先创建自己的 demo 站点，然后通过单击以下链接将其部署到 Vercel:

<a
  className="mt-3 inline-flex"
  target="_blank"
  href="https://vercel.com/new/clone?s=https%3A%2F%2Fgithub.com%2Fcanyon-project%2Fcanyon-babel-template&showOptionalTeamCreation=false"
>
  ![](https://vercel.com/button)
</a>

### 克隆模版

You can also manually fork the
[template repository](https://github.com/canyon-project/canyon-babel-template).


## 以新项目开始

<Steps>
  ### 安装

  前端工程化、模块化离不开babel。如果说你的项目是的话，只需要安装两个babel插件即可快速开始。

  ```sh npm2yarn
  npm install babel-plugin-istanbul babel-plugin-canyon -D
  ```

  在[babel](https://babeljs.io/docs/config-files#configuration-file-types)中添加`canyon`和`istanbul`插件。
  ```js {3,4}
  module.exports = {
    plugins: progress.env.GITLAB_BRANCH === 'production' ? [
      'canyon',
      'istanbul',
    ]:[],
  };
  ```
  <Callout>
    插件会拖慢开发环境的编译速度，所以您需要控制插件生效的条件。
  </Callout>

  配置完成后启动项目，在控制打印 **window.\_\_coverage\_\_** 。如果跟下图一样那么代码插桩成功。

  ![coverage-canyon-console](/static/documentation/getting-started/first-coverage/coverage-canyon-console.png)


  ### CI 环境变量

  在CI环境中，我们需要配置一些环境变量，用于上报覆盖率数据。

  1. 获取DSN与REPORTER

  - DSN: Canyon提供的上报接口，\{\{url\}\}/coverage/client，其中url为Canyon后端服务地址。
  - REPORTER: 用户token，用于区分不同的用户。可前往用户设置页查看。

  ![setting](/static/documentation/getting-started/first-coverage/setting.png)

  2. CI平台变量配置

  ![gitlab](/static/documentation/getting-started/first-coverage/gitlab-var-config.png)


  <Callout type="info" emoji="ℹ️">
    其中Branch、SHA、Project ID不需要配置，会自动读取环境变量。我们已经适配了gitlab pipeline等CI平台。
  </Callout>



  3. hit 和 map 数据分离（可选）

  UI自动化会会产生大量覆盖率数据，为了减少数据传输量，我们建议您将 [hit 数据与 map 数据分离](/test)。



  ### 覆盖率数据上报

  此时覆盖率数据处与浏览器中，随着用户的操作或者UI自动化case执行，数据会不断积累。我们需要将数据上报到Canyon后端服务。

<Cards>
  <Cards.Card
    title="UI 自动化上报"
    href="/docs/guide/built-ins/callout"
  />
  <Cards.Card
    title="手动上报"
    href="/docs/guide/built-ins/tabs"
  />
</Cards>
</Steps>
