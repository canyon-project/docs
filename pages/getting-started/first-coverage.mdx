# 上报第一个覆盖率

## 代码插桩

前端工程化、模块化离不开babel。如果说你的项目是的话，只需要安装两个babel插件即可快速开始，
[`babel-plugin-istanbul`](https://github.com/istanbuljs/babel-plugin-istanbul) 是istanbul官方维护的babel插件。
[`babel-plugin-canyon`](https://github.com/canyon-project/babel-plugin-canyon) 我们是为了便于用户配置项目信息的babel插件。

```shell copy
npm i babel-plugin-istanbul babel-plugin-canyon -D
```

在[babel](https://babeljs.io/docs/config-files#configuration-file-types)中配置
```json
{
  "plugins": [
    "istanbul",
    "canyon"
  ]
}
```

babel安装完成后启动项目，在控制打印**window.\_\_canyon\_\_**与**window.\_\_coverage\_\_**。如果跟下图一样那么恭喜你，代码插桩成功。

![coverage-canyon-console](/coverage-canyon-console.png)



## 构建时环境变量配置

在CI/CD环境中，我们需要配置一些环境变量，用于上报覆盖率数据。

在gitlab仓库的ci中配置构建时环境变量123

![gitlab](/gitlab-var-config.png)

其中branch、commit_sha、project_id不需要配置，会自动读取环境变量。我们已经适配了gitlab、github、gitee、coding等平台。
具体可查看[支持的provider列表](/reference/supported-ci-providers)。




## 测试与上报

- UI自动化 我们用flytest测试平台合作，在UI自动化中会自动收集覆盖率数据并上报。
- 手工上报 chrome可以使用chrome插件[canyon-extension](https://chromewebstore.google.com/detail/canyon-extension/omnpafdjidgpdmlimbangcjjaaodbeof?hl=zh-CN&utm_source=ext_sidebar)手工上报覆盖率数据。

## 覆盖率报告查看

dsn: 覆盖率上报接口，可用 https://canyon.com/coverage/client

reporter: 上报人的身份令牌，请至 [覆盖率平台](https://canyon.com/settings) 查看

projectID: 仓库ID，会自动读取环境变量CI_PROJECT_ID

commitSha: 会自动读取环境变量CI_COMMIT_SHA

coverage: 项目覆盖率对象
